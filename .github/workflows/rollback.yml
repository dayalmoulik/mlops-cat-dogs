name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      revision:
        description: 'Revision to rollback to (leave empty for previous)'
        required: false
        type: string

env:
  K8S_NAMESPACE: ml-models

jobs:
  rollback:
    name: Rollback Kubernetes Deployment
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.27.0'
    
    # Configure kubectl here (same as CD pipeline)
    
    - name: Get rollout history
      run: |
        echo "Current rollout history:"
        kubectl rollout history deployment/cats-dogs-classifier -n ${{ env.K8S_NAMESPACE }}
    
    - name: Rollback deployment
      run: |
        if [ -z "${{ github.event.inputs.revision }}" ]; then
          echo "Rolling back to previous revision..."
          kubectl rollout undo deployment/cats-dogs-classifier -n ${{ env.K8S_NAMESPACE }}
        else
          echo "Rolling back to revision ${{ github.event.inputs.revision }}..."
          kubectl rollout undo deployment/cats-dogs-classifier \
            --to-revision=${{ github.event.inputs.revision }} \
            -n ${{ env.K8S_NAMESPACE }}
        fi
    
    - name: Wait for rollback
      run: |
        kubectl rollout status deployment/cats-dogs-classifier -n ${{ env.K8S_NAMESPACE }} --timeout=5m
    
    - name: Verify rollback
      run: |
        echo "Rollback completed. Current status:"
        kubectl get deployment cats-dogs-classifier -n ${{ env.K8S_NAMESPACE }}
        kubectl get pods -n ${{ env.K8S_NAMESPACE }}
    
    - name: Run smoke tests
      run: |
        SERVICE_IP=$(kubectl get svc cats-dogs-service -n ${{ env.K8S_NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        if [ -n "$SERVICE_IP" ]; then
          python scripts/smoke_test.py http://$SERVICE_IP
        fi
    
    - name: Rollback summary
      run: |
        echo "=================================="
        echo "Rollback Complete!"
        echo "=================================="
        kubectl rollout history deployment/cats-dogs-classifier -n ${{ env.K8S_NAMESPACE }} | tail -5
